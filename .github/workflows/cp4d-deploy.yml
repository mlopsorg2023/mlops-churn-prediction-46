name: train-and-deploy-churn-model

on:
  push:
    branches: [ "prd" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:

  run-training-jobs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          path: mlops-churn-prediction-46

      - name: Ensure scripts are runnable
        run: |
          chmod +x mlops-churn-prediction-46/src/scripts/*.sh

      - name: Show environment variables
        run: |
          env

      - name: Download cdpctl
        run: |
          mlops-churn-prediction-46/src/scripts/download-cpdctl.sh

      - name: Set up cpdctl credentials
        env:
          CPD_USER_NAME: ${{ secrets.CPD_USER_NAME }}
          CPD_USER_PASSWORD: ${{ secrets.CPD_USER_PASSWORD }}
          CPD_URL: ${{ vars.CPD_URL }}
        run: |
          mlops-churn-prediction-46/src/scripts/configure-cpdctl.sh

      - name: Import and code package and run job
        env:
          CURRENT_BRANCH: ${{ vars.GITHUB_REF_NAME }}
        run: |
          mlops-churn-prediction-46/src/scripts/import-code-package.sh